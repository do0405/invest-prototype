# Cup 앤 핸들(Cup and Handle) 및 VCP(Volume Contraction Pattern) 검출 알고리즘 설계

**핵심 요약**  
- **컵 앤 핸들**: 가격곡선을 커널 회귀(kernel regression)로 부드럽게(smoothing) 처리한 뒤, U자형 ‘컵’과 짧은 ‘핸들’ 구간을 기하학적·볼륨 기준으로 정의하여 탐지  
- **VCP**: 고점 부근에서 가격은 횡보하되 거래량이 단계적으로 줄어드는 수축 패턴을, 피벗(pivot) 및 거래량 수식으로 정량화  
- **주요 참고 논문**  
  1. Lo, Mamaysky & Wang (2000): 비선형 커널 회귀 기반 차트 패턴 인식[1]  
  2. Suh et al. (―): Bezier 곡선 이용 컵 앤 핸들 역방향 스크리닝[2]  

## 1. 공통 전처리

1. **가격 시계열 정규화**  
   $$
     P_t' = \frac{P_t - \min(P)}{\max(P) - \min(P)}
   $$  
2. **커널 회귀에 의한 스무딩**  
   Lo et al.[1] 제안:
   $$
     \hat P(x) = \frac{\sum_{i=1}^n K\bigl(\frac{x - x_i}{h}\bigr)P_i}{\sum_{i=1}^n K\bigl(\frac{x - x_i}{h}\bigr)},
     \quad K(u)=e^{-u^2/2}
   $$
   - 대역폭 $$h$$는 경험적으로 5~10일 범위  

3. **1·2차 미분 기반 커브 형태 분석**  
   - $$\hat P'(t)>0$$에서 $$\hat P''(t)0$$로 전환되는 지점: 컵 저점  

## 2. 컵 앤 핸들 검출

### 2.1 컵(Cup) 정의
- **시작점 A**, **저점 B**, **끝점 C** 식별  
  1. **A (왼쪽 림)**: 국소 최대점, $$\hat P''(A)0$$  
  3. **C (오른쪽 림)**: A와 유사 수준, $$\hat P(C)\ge0.9\hat P(A)$$  
- **U자 조건**:  
  $$
    \frac{\hat P(A) - \hat P(B)}{\hat P(A)} \le 0.20
    \quad\text{(깊이 20% 이내)}
  $$
- **폭(기간)**:  
  $$
    20 \le (B - A) \le 60 \text{ 거래일}
  $$

### 2.2 핸들(Handle) 정의
- **시작점 C**에서 가격이 소폭 하락해 핸들 구간(D) 형성  
- **핸들 저점 D**:  
  $$
    \hat P(D) \ge 0.85\,\hat P(C)
  $$
- **기간**:  
  $$
    3 \le (D - C) \le 20 \text{ 거래일}
  $$
- **거래량 조건**  
  - 컵 형성 중 평균 거래량 $$V_{\text{cup}}$$와 비교해  
    $$\bar V_{\text{handle}} \le 0.8\,V_{\text{cup}}$$  
  - 돌파일(E) 거래량:  
    $$\displaystyle V_E \ge V_{\text{cup,max}}$$

### 2.3 역방향 스크리닝 알고리즘 (Suh et al.)  
1. **백워드 스크리닝**: 후보구간(크기 100일 단위)을 뒤에서부터  
2. **Bezier 곡선 적합**: 컵 형태 일치도 측정[2]  
3. **통계 검정**: 컵 U자형 여부 $$\chi^2$$ 검정  

## 3. VCP(Volume Contraction Pattern) 검출

### 3.1 패턴 개요
- **고점 피벗(Pivot)** 형성 후, 가격은 횡보  
- **단계적 거래량 수축**:  
  - 연속 3~8 구간에서 거래량 지표 $$\bar V_i$$가  
    $$\bar V_{i+1}<\bar V_i$$로 감소  
- **가격 범위**  
  $$
    \max P - \min P \le 10\%\times \min P
  $$

### 3.2 수식 및 절차
1. **피벗 찾기**:  
   $$\hat P(t)$$가 최근 $$n$$일 최고점이면 피벗 $$T_0$$  
2. **수축 구간 분할**:  
   $$
     [T_0,T_1],\,[T_1,T_2],\dots,[T_{k-1},T_k]
   $$
   (각 구간 길이 3~5일)
3. **거래량 수축 검증**:  
   $$
     \bar V_{j+1} = \frac{1}{|[T_j,T_{j+1}]|}\sum_{t=T_j}^{T_{j+1}}V_t,
     \quad \bar V_{j+1}<\bar V_j
   $$
4. **가격 안정성**:  
   $$\max_{t\in[T_0,T_k]}P_t - \min_{t\in[T_0,T_k]}P_t \le 0.1\,\min_{t}P_t$$

## 4. OpenCV 기반 구현 가이드

1. **데이터 로딩**: CSV → `cv::Mat`  
2. **커널 회귀**: 커스텀 함수로 이중 합산 구현  
3. **1·2차 미분**: OpenCV `filter2D` 활용  
4. **극값 검출**: `cv::findContours` 유사 개념으로 전환  
5. **패턴 규칙 적용**: 수식(위 2·3절) 코드화  
6. **볼륨 조건**: `cv::reduce`로 구간별 평균산출  
7. **시각화**: `cv::polylines`로 컵·핸들·VCP 구간 표시  

각 단계의 **수식**과 **판별 기준**을 정확히 구현하면, AI IDE가 100% 자동 생성 가능한 형태의 마크다운 명세가 완성됩니다.
