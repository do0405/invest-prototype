# 포트폴리오 관리 시스템 구현 프롬프트

## 시스템 개요
6개의 트레이딩 전략(시스템 1-6)을 기반으로 한 포트폴리오 관리 시스템을 구현해주세요. 기존 아키텍처와 코드 구조를 최대한 활용하면서 아래 요구사항을 충족하도록 개발해주세요.

## 핵심 요구사항

### 1. 포트폴리오 초기 생성 (포트폴리오 CSV 파일이 없을 경우)

**스크리닝 및 포트폴리오 생성:**
- 6개 시스템의 필터, 설정, 순위 조건에 따라 종목 스크리닝 실행
- 각 시스템별로 최대 10개 포지션 생성 (총 최대 60개 포지션)
- 포지션당 자산 배분: min(총자산 대비 2% 리스크 기준 계산값, 총자산의 10%) 적용

**시장가 주문 처리:**
- 시장가 매수/매도 시스템의 경우, 생성일에는 "시장가"라는 텍스트로 CSV에 기록
- 다음 업데이트 시 매수일 다음날 시가로 실제 가격 업데이트
- 시장가 관련 계산값은 "시장가 + [계산값]" 형태로 저장 (예: "시장가 + 21")
- 시장가 가격 확정 후 해당 계산값들을 실제 가격으로 자동 변환



### 2. 포트폴리오 추적 및 업데이트 (포트폴리오 CSV 파일이 있을 경우)

**일일 추적 업데이트:**
- 모든 포지션의 현재가, 수익률 실시간 업데이트
- 각 시스템별 수익보호 로직 적용:
  - 시스템 1: 25% 추격 역지정가 (수익 발생 시 수익보호가 상향 조정)
  - 시스템 4: 20% 추격 역지정가 (수익 발생 시 수익보호가 상향 조정)
  - 기타 시스템: 수익보호 없음
- 각 시스템별 차익실현 조건 모니터링 (시간 기반, 수익률 기준, ATR 기준 등)

**퇴출 조건 체크 (Long 포지션):**
- 전날 저가 ≤ 손절가 또는 수익보호가 → 포지션 청산
- 전날 고가 ≥ 수익실현가 → 포지션 청산
- 시간 기반 청산 조건 충족 시 → 포지션 청산

**퇴출 조건 체크 (Short 포지션):**
- 전날 고가 ≥ 손절가 또는 수익보호가 → 포지션 청산
- 전날 저가 ≤ 수익실현가 → 포지션 청산
- 시간 기반 청산 조건 충족 시 → 포지션 청산

**신규 포지션 충원:**
- 퇴출된 포지션만큼 해당 시스템의 스크리닝을 재실행
- 기존 보유 종목 제외하고 순위 상위 종목부터 우선 선택
- 최대 포지션 수 최대한 유지 (시스템별 최대 10개, 조건 충족 종목이 부족할 경우 일시적으로 미달 허용)

## 기존 구현 검증 요구사항

**strategy1~6.py 파일 검증:**
- 각 시스템별 구현 파일(strategy1.py ~ strategy6.py)이 strategy1~6.md의 명세를 정확히 따르고 있는지 확인
- 필터 조건, 설정 조건, 순위 로직이 올바르게 구현되었는지 검증
- 진입가, 손절가, 수익보호가, 차익실현 로직이 명세와 일치하는지 점검
- 포지션 크기 계산이 min(총자산 대비 2% 리스크 기준, 총자산의 10%) 로직으로 구현되었는지 확인
- 시장가 주문 처리 로직이 올바르게 구현되었는지 검증

**strategy1~6.md 참조 구현:**
- 시스템 1: 트렌드 하이 모멘텀 롱 - S&P500 필터, 변동성 순위, 추격 역지정가 로직
- 시스템 2: 평균회귀 단일 숏 - RSI 90+ 조건, ADX 순위, 시간 기반 청산
- 시스템 3: 평균회귀 셀오프 롱 - 150일 MA 필터, 3일 하락폭 조건, 시간 기반 청산
- 시스템 4: 트렌드 저변동성 롱 - 변동성 범위 필터, RSI 순위, 추격 역지정가
- 시스템 5: 평균회귀 하이 ADX 리버살 롱 - ADX 55+ 조건, ATR 상단 청산 로직
- 시스템 6: 평균회귀 6일 급등 숏 - 6일 20% 상승 조건, 시간 기반 청산

구현 검증 후 누락되거나 잘못된 부분이 있다면 수정 사항을 명확히 제시해주세요.

## 기술적 요구사항

**데이터 소스 통합:**
- 기존 데이터 파이프라인과 호환성 유지
- Yahoo Finance, Alpha Vantage 등 기존 API 활용
- 실시간 가격 데이터 및 기술적 지표 계산

**에러 처리 및 로깅:**
- 각 단계별 상세 로그 기록
- API 호출 실패, 데이터 누락 시 대체 로직
- 퇴출/신규 진입 내역 별도 로그 파일 관리

**성능 최적화:**
- 대량 종목 처리 시 병렬 처리 구현
- 캐싱 메커니즘으로 중복 API 호출 최소화
- 메모리 효율적인 데이터 구조 사용

**설정 관리:**
- 시스템별 파라미터 외부 설정 파일로 관리
- 총자산 규모, 리스크 비율 등 글로벌 설정 분리
- 개발/운영 환경별 설정 구분

## 구현 우선순위

1. **Phase 1**: 포트폴리오 초기 생성 및 CSV 저장 기능
2. **Phase 2**: 일일 추적 및 업데이트 기능
3. **Phase 3**: 자동 퇴출 및 신규 충원 기능
4. **Phase 4**: 성능 최적화 및 고도화

## 주의사항

- 기존 코드베이스의 함수명, 변수명, 구조를 최대한 재사용하세요
- 각 시스템의 세부 조건을 정확히 구현하고 테스트하세요
- 실제 거래 전 백테스팅 모드로 충분한 검증을 수행하세요
- 시장 휴장일, 거래 정지 종목 등 예외 상황을 고려하세요

기존 아키텍처를 기반으로 위 요구사항을 단계적으로 구현해주시고, 각 Phase별로 테스트 가능한 형태로 제공해주세요.